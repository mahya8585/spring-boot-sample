# yaml-language-server: $schema=https://raw.githubusercontent.com/Azure/azure-dev/refs/heads/main/schemas/v1.0/azure.yaml.json

name: techbookstore
metadata:
  template: techbookstore@1.0.0

services:
  backend:
    project: ./backend
    language: java
    host: containerapp
    docker:
      path: ./Dockerfile
      context: .

  frontend:
    project: ./frontend
    language: js
    host: containerapp
    docker:
      path: ./Dockerfile
      context: .

hooks:
  postprovision:
    windows:
      shell: pwsh
      run: |
        Write-Host "Installing Service Connector extension..."
        az extension add --name serviceconnector-passwordless --upgrade --only-show-errors
        az provider register --namespace Microsoft.ServiceLinker --wait --only-show-errors
        
        $subscriptionId = azd env get-value AZURE_SUBSCRIPTION_ID
        $resourceGroup = azd env get-value AZURE_RESOURCE_GROUP
        $backendAppName = azd env get-value BACKEND_APP_NAME
        $postgresqlHost = azd env get-value AZURE_POSTGRESQL_HOST
        $postgresqlDatabase = azd env get-value AZURE_POSTGRESQL_DATABASE
        $redisHost = azd env get-value AZURE_REDIS_HOST
        $userManagedIdentityClientId = azd env get-value USER_MANAGED_IDENTITY_CLIENT_ID
        
        # Extract PostgreSQL server name from FQDN
        $postgresqlServerName = $postgresqlHost.Split('.')[0]
        
        # Extract Redis name from FQDN
        $redisName = $redisHost.Split('.')[0]
        
        Write-Host "Creating PostgreSQL connection with Service Connector..."
        az containerapp connection create postgres-flexible `
          --connection postgres_connection `
          --source-id /subscriptions/$subscriptionId/resourceGroups/$resourceGroup/providers/Microsoft.App/containerApps/$backendAppName `
          --target-id /subscriptions/$subscriptionId/resourceGroups/$resourceGroup/providers/Microsoft.DBforPostgreSQL/flexibleServers/$postgresqlServerName `
          --database $postgresqlDatabase `
          --user-identity "client-id=$userManagedIdentityClientId subs-id=$subscriptionId" `
          --client-type springBoot `
          -c backend `
          -y `
          --only-show-errors
        
        Write-Host "PostgreSQL connection created successfully"
        
        Write-Host "Creating Redis connection with Service Connector..."
        az containerapp connection create redis `
          --connection redis_connection `
          --source-id /subscriptions/$subscriptionId/resourceGroups/$resourceGroup/providers/Microsoft.App/containerApps/$backendAppName `
          --target-id /subscriptions/$subscriptionId/resourceGroups/$resourceGroup/providers/Microsoft.Cache/redis/$redisName `
          --user-identity "client-id=$userManagedIdentityClientId subs-id=$subscriptionId" `
          --client-type springBoot `
          -c backend `
          -y `
          --only-show-errors
        
        Write-Host "Redis connection created successfully"
        
        Write-Host "Verifying connections..."
        az containerapp connection list `
          --resource-group $resourceGroup `
          --name $backendAppName `
          -o table
        
        Write-Host "Post-provision hooks completed successfully"
      continueOnError: false
    posix:
      shell: sh
      run: |
        echo "Installing Service Connector extension..."
        az extension add --name serviceconnector-passwordless --upgrade --only-show-errors
        az provider register --namespace Microsoft.ServiceLinker --wait --only-show-errors
        
        subscriptionId=$(azd env get-value AZURE_SUBSCRIPTION_ID)
        resourceGroup=$(azd env get-value AZURE_RESOURCE_GROUP)
        backendAppName=$(azd env get-value BACKEND_APP_NAME)
        postgresqlHost=$(azd env get-value AZURE_POSTGRESQL_HOST)
        postgresqlDatabase=$(azd env get-value AZURE_POSTGRESQL_DATABASE)
        redisHost=$(azd env get-value AZURE_REDIS_HOST)
        userManagedIdentityClientId=$(azd env get-value USER_MANAGED_IDENTITY_CLIENT_ID)
        
        # Extract PostgreSQL server name from FQDN
        postgresqlServerName=$(echo $postgresqlHost | cut -d'.' -f1)
        
        # Extract Redis name from FQDN
        redisName=$(echo $redisHost | cut -d'.' -f1)
        
        echo "Creating PostgreSQL connection with Service Connector..."
        az containerapp connection create postgres-flexible \
          --connection postgres_connection \
          --source-id /subscriptions/$subscriptionId/resourceGroups/$resourceGroup/providers/Microsoft.App/containerApps/$backendAppName \
          --target-id /subscriptions/$subscriptionId/resourceGroups/$resourceGroup/providers/Microsoft.DBforPostgreSQL/flexibleServers/$postgresqlServerName \
          --database $postgresqlDatabase \
          --user-identity "client-id=$userManagedIdentityClientId subs-id=$subscriptionId" \
          --client-type springBoot \
          -c backend \
          -y \
          --only-show-errors
        
        echo "PostgreSQL connection created successfully"
        
        echo "Creating Redis connection with Service Connector..."
        az containerapp connection create redis \
          --connection redis_connection \
          --source-id /subscriptions/$subscriptionId/resourceGroups/$resourceGroup/providers/Microsoft.App/containerApps/$backendAppName \
          --target-id /subscriptions/$subscriptionId/resourceGroups/$resourceGroup/providers/Microsoft.Cache/redis/$redisName \
          --user-identity "client-id=$userManagedIdentityClientId subs-id=$subscriptionId" \
          --client-type springBoot \
          -c backend \
          -y \
          --only-show-errors
        
        echo "Redis connection created successfully"
        
        echo "Verifying connections..."
        az containerapp connection list \
          --resource-group $resourceGroup \
          --name $backendAppName \
          -o table
        
        echo "Post-provision hooks completed successfully"
      continueOnError: false
