# Azure Deployment Plan for TechBookStore Project

## **Goal**
Deploy the TechBookStore project to Azure using Azure Developer CLI (azd) with Bicep infrastructure as code. This plan will provision all required Azure resources and deploy both backend and frontend services to Azure Container Apps.

## **Project Information**

**TechBookStore - Technical Bookstore Inventory Management System**
- **Backend Stack**: Spring Boot 3.5.0 with Java 21, JPA/Hibernate, Spring Security
- **Frontend Stack**: React 16 with Material-UI 4, Redux state management
- **Type**: Full-stack inventory management web application for technical bookstore
- **Containerization**: Dockerfiles present for both backend and frontend
- **Backend Dependencies**: 
  - PostgreSQL (production database)
  - Redis (caching and session storage)
  - Azure Key Vault (secrets management)
  - Application Insights (monitoring)
  - Azure Container Registry (image storage)
- **Frontend Dependencies**: Backend API (HTTP)
- **Hosting**: Azure Container Apps for both services
- **Features**: Book catalog management, inventory operations, customer/order management, analytics dashboards, i18n (Japanese/English)

## **Azure Resources Architecture**
> **Install the mermaid extension in IDE to view the architecture.**

```mermaid
graph TD
%% Services
svcazurecontainerapps_backend["`Name: backend
Path: backend
Language: java`"]
svcazurecontainerapps_frontend["`Name: frontend
Path: frontend
Language: js`"]
subgraph "Compute Resources"
%% Resources
subgraph containerappenv["Azure Container Apps (ACA) Environment"]
azurecontainerapps_backend("`backend (Azure Container App)`")
azurecontainerapps_frontend("`frontend (Azure Container App)`")
end
containerappenv:::cluster
end
subgraph "Dependency Resources"
%% Dependency Resources
azuredatabaseforpostgresql_postgres["`postgres (Azure Database for PostgreSQL)`"]
azurecacheforredis_redis["`redis (Azure Cache for Redis)`"]
azurekeyvault_keyvault["`keyvault (Azure Key Vault)`"]
azureapplicationinsights_appinsights["`appinsights (Azure Application Insights)`"]
azurecontainerregistry_containerregistry["`containerregistry (Azure Container Registry)`"]
end
%% Relationships
svcazurecontainerapps_backend --> |"hosted on"| azurecontainerapps_backend
azurecontainerapps_backend -.-> |"system-identity"| azuredatabaseforpostgresql_postgres
azurecontainerapps_backend -.-> |"system-identity"| azurecacheforredis_redis
azurecontainerapps_backend -.-> |"system-identity"| azurekeyvault_keyvault
azurecontainerapps_backend -.-> |"system-identity"| azureapplicationinsights_appinsights
azurecontainerapps_backend -.-> |"system-identity"| azurecontainerregistry_containerregistry
svcazurecontainerapps_frontend --> |"hosted on"| azurecontainerapps_frontend
azurecontainerapps_frontend -.-> |"http"| azurecontainerapps_backend
```

**Resource Relationships:**
- The backend Container App gets its container images from Azure Container Registry
- The backend Container App connects to Azure Database for PostgreSQL using system-assigned managed identity for persistent data storage
- The backend Container App connects to Azure Cache for Redis using system-assigned managed identity for caching and session management
- The backend Container App retrieves secrets from Azure Key Vault using system-assigned managed identity for secure configuration
- The backend Container App sends telemetry to Application Insights for monitoring and diagnostics
- The frontend Container App serves the React application via Nginx and makes HTTP requests to the backend Container App
- Both Container Apps run in the same Azure Container Apps Environment for optimal networking and resource sharing

## **Recommended Azure Resources**

### Application 1: TechBookStore Backend
- **Hosting Service Type**: Azure Container Apps
- **SKU**: Consumption (0.25 vCPU, 0.5 GB memory per instance, auto-scaling 0-10 replicas)
  - Performance: Suitable for development and moderate production workloads with auto-scaling capabilities
- **Configuration**:
  - Language: Java 21
  - Environment Variables:
    - `SPRING_PROFILES_ACTIVE`: prod
    - `CORS_ALLOWED_ORIGINS`: Frontend URL (auto-configured)
    - `AZURE_KEYVAULT_ENDPOINT`: Key Vault URL (auto-configured via Service Connector)
    - `SPRING_DATASOURCE_URL`: PostgreSQL connection (auto-configured via Service Connector)
    - `SPRING_REDIS_HOST`: Redis host (auto-configured via Service Connector)
    - `APPLICATIONINSIGHTS_CONNECTION_STRING`: App Insights connection string
  - dockerFilePath: backend/Dockerfile
  - dockerContext: backend
- **Dependencies Resources**:
  1. **PostgreSQL Database**
     - Name: postgres
     - SKU: Burstable B1ms (1 vCore, 2 GB memory, 32 GB storage)
     - Performance: Cost-effective for development and small production workloads
     - Service Type: Azure Database for PostgreSQL Flexible Server
     - Connection Type: System-Assigned Managed Identity (passwordless)
     - Environment Variables: Auto-configured by Service Connector
  2. **Redis Cache**
     - Name: redis
     - SKU: Basic C0 (250 MB cache)
     - Performance: Entry-level tier suitable for development and testing
     - Service Type: Azure Cache for Redis
     - Connection Type: System-Assigned Managed Identity (passwordless)
     - Environment Variables: Auto-configured by Service Connector
  3. **Key Vault**
     - Name: keyvault
     - SKU: Standard
     - Service Type: Azure Key Vault
     - Connection Type: System-Assigned Managed Identity with RBAC
     - Environment Variables: `AZURE_KEYVAULT_ENDPOINT`
  4. **Application Insights**
     - Name: appinsights
     - Service Type: Azure Application Insights
     - Connection Type: Connection string
     - Environment Variables: `APPLICATIONINSIGHTS_CONNECTION_STRING`
  5. **Container Registry**
     - Name: containerregistry
     - SKU: Basic
     - Service Type: Azure Container Registry
     - Connection Type: System-Assigned Managed Identity with AcrPull role

### Application 2: TechBookStore Frontend
- **Hosting Service Type**: Azure Container Apps
- **SKU**: Consumption (0.25 vCPU, 0.5 GB memory per instance, auto-scaling 0-10 replicas)
  - Performance: Suitable for serving static React application with Nginx
- **Configuration**:
  - Language: JavaScript (Node.js 16 for build, Nginx for runtime)
  - Environment Variables:
    - `REACT_APP_API_URL`: Backend API URL (auto-configured)
  - dockerFilePath: frontend/Dockerfile
  - dockerContext: frontend
- **Dependencies Resources**:
  1. **Backend Container App**
     - Name: backend
     - Service Type: Azure Container App
     - Connection Type: HTTP
     - Environment Variables: `REACT_APP_API_URL` (configured to backend FQDN)

## **Recommended Supporting Services**:
- **Application Insights**: Centralized application monitoring and diagnostics for both backend and frontend
- **User-Assigned Managed Identity**: Secure identity for accessing Azure resources without storing credentials
- **Log Analytics Workspace**: Centralized logging for Container Apps environment and all services
- **Key Vault**: Secure storage for application secrets and connection strings
- **Container Registry**: Private Docker image repository for backend and frontend containers

## **Recommended Security Configurations**:
- User-Assigned Managed Identity must have Key Vault Secrets User role on the Key Vault
- User-Assigned Managed Identity must be assigned to both backend and frontend Container Apps
- AcrPull role assignment: User-Assigned Managed Identity must have **AcrPull** role (7f951dda-4ed3-4680-a7ca-43fe172d538d) assigned to the Container Registry
- Backend Container App system-assigned managed identity must have permissions to:
  - PostgreSQL database (configured via Service Connector)
  - Redis cache (configured via Service Connector)
  - Key Vault (Key Vault Secrets User role)
- All resources should use HTTPS/TLS for communication
- Disable admin user on Container Registry (use managed identity instead)

## **Execution Steps**
> **Below are the steps for Copilot to follow; ask Copilot to update or execute this plan. Add check list for the steps.**

### 1. Containerization:
- [x] Backend Dockerfile exists at: `backend/Dockerfile`
  - Build context: `backend/`
  - Port: 8080
  - Base image: eclipse-temurin:21-jre-jammy
- [x] Frontend Dockerfile exists at: `frontend/Dockerfile`
  - Build context: `frontend/`
  - Port: 80
  - Base image: nginx:1.25-alpine
- [ ] Validate Docker images can be built successfully:
  - Test build backend: `docker build -f backend/Dockerfile backend/`
  - Test build frontend: `docker build -f frontend/Dockerfile frontend/`

### 2. Create Azure Infrastructure Files for AZD:
1. **Provisioning tool**: AZD
   - **Expected files**: `azure.yaml`, `infra/main.bicep`, `infra/main.parameters.json`
2. [ ] Get current subscription ID and check available regions/SKUs:
   - Run: `az account show --query id -o tsv`
   - Call tool `appmod-get-available-region-sku` to get available regions and SKUs for:
     - Microsoft.App/containerApps
     - Microsoft.App/managedEnvironments
     - Microsoft.ContainerRegistry/registries
     - Microsoft.DBforPostgreSQL/flexibleServers
     - Microsoft.Cache/redis
     - Microsoft.KeyVault/vaults
     - Microsoft.Insights/components
3. [ ] Check existing infrastructure files:
   - Existing file paths found:
     - `infra/main.bicep` ‚úì
     - `infra/main.parameters.json` ‚úì
     - `azure.yaml` ‚úó (MISSING - must be created)
   - [ ] Review existing Bicep files and verify they match requirements:
     - Container Apps Environment ‚úì
     - Backend Container App ‚úì
     - Frontend Container App ‚úì
     - PostgreSQL Flexible Server ‚úì
     - Redis Cache ‚úì
     - Key Vault ‚úì
     - Container Registry ‚úì
     - Application Insights ‚úì
     - Log Analytics ‚úì
     - Managed Identity ‚úì
   - [ ] If any resources are missing, update Bicep files accordingly
4. [ ] Generate missing `azure.yaml` file:
   - Call tool `appmod-get-iac-rules` with parameters:
     - deploymentTool: "azd"
     - iacType: "bicep"
     - resourceTypes: ["containerapp", "azuredatabaseforpostgresql", "azurecacheforredis", "azurekeyvault", "azurecontainerregistry", "azureapplicationinsights"]
     - workspaceFolder: "c:/local-m/github/spring-boot-sample"
   - Generate `azure.yaml` with:
     - Backend service configuration
     - Frontend service configuration
     - Post-provision hooks for Service Connector
5. [ ] Post-provisioning configuration in azure.yaml hooks:
   - Add `hooks.postprovision` section with scripts to:
     - Create PostgreSQL connection: `az containerapp connection create postgres-flexible --connection postgres-connection --system-identity --client-type springBoot --source-id <backend-resource-id> --target-id <postgres-resource-id> --database techbookstore -y`
     - Create Redis connection: `az containerapp connection create redis --connection redis-connection --system-identity --client-type springBoot --source-id <backend-resource-id> --target-id <redis-resource-id> -y`
     - Verify connections: `az containerapp connection list --resource-group <rg-name> --name <backend-app-name>`
     - Grant Key Vault access to backend managed identity
6. [ ] Validate generated files:
   - Call `get_errors` on all Bicep files
   - Fix any syntax errors or validation issues
   - Run: `az bicep build --file infra/main.bicep` to verify compilation

### 3. Environment Setup for azd:
1. [ ] Install required tools if not present:
   - Azure CLI: Check with `az --version` (install from https://aka.ms/installazurecliwindows)
   - Azure Developer CLI: Check with `azd version` (install with `winget install microsoft.azd`)
2. [ ] Create azd environment:
   - Run: `azd env new <envName> --no-prompt` (suggest name like "techbookstore-prod" or "techbookstore-dev")
   - If environment exists, verify it matches requirements
3. [ ] Review and set required environment variables:
   - From `infra/main.bicep` parameters:
     - `environmentName`: azd environment name
     - `location`: Azure region (from available regions query)
     - `postgresqlAdminUsername`: PostgreSQL admin username
     - `postgresqlAdminPassword`: Secure password for PostgreSQL
     - `postgresqlDatabaseName`: techbookstore (default)
   - Set variables using: `azd env set <key> <value>`
   - Get subscription ID: `azd env set AZURE_SUBSCRIPTION_ID $(az account show --query id -o tsv)`
4. [ ] Set default subscription (if not already set):
   - Use current subscription from `az account show`
5. [ ] Create resource group for deployment:
   - Extract target scope from `infra/main.bicep` (currently: resourceGroup)
   - Run: `az group create --name <rg-name> --location <location>`
   - Set: `azd env set AZURE_RESOURCE_GROUP <rg-name>`
6. [ ] Install Service Connector Azure CLI extension:
   - Run: `az extension add --name serviceconnector-passwordless --upgrade`
   - Verify: `az extension show --name serviceconnector-passwordless`

### 4. Deployment:
1. [ ] Preview infrastructure deployment (dry run):
   - Run: `azd provision --preview --no-prompt`
   - Review output for any errors or warnings
   - Fix any issues in Bicep files and retry
2. [ ] Full deployment (provision + deploy):
   - Run: `azd up --no-prompt`
   - This will:
     - Provision all Azure resources
     - Build Docker images
     - Push images to Container Registry
     - Deploy containers to Container Apps
     - Execute post-provision hooks
   - Monitor output for errors
   - If errors occur:
     - Review error messages
     - Fix issues (Bicep, Dockerfile, or configuration)
     - Retry: `azd up --no-prompt`
3. [ ] Deployment validation:
   - Call tool `appmod-get-azd-app-logs` to check application logs
   - Verify backend service is running:
     - Check health endpoint: `https://<backend-fqdn>/actuator/health`
     - Review logs for startup errors
   - Verify frontend service is running:
     - Access frontend URL: `https://<frontend-fqdn>`
     - Test UI functionality
   - Verify database connectivity:
     - Check backend logs for PostgreSQL connection success
   - Verify Redis connectivity:
     - Check backend logs for Redis connection success
   - Verify Key Vault access:
     - Check backend logs for Key Vault secret retrieval
   - Check Application Insights:
     - Verify telemetry data is being collected

### 5. Summarize Result:
1. [ ] Generate deployment summary:
   - Call tool `appmod-summarize-result` to create comprehensive summary
   - Output file: `.azure/summary.copilotmd`
2. [ ] Document deployment information:
   - Resource group name
   - Azure region
   - Backend Container App FQDN
   - Frontend Container App FQDN
   - PostgreSQL server name
   - Redis cache name
   - Key Vault name
   - Application Insights connection string
   - Environment variables configured

## **Progress Tracking**
Copilot must create and update `.azure/progress.copilotmd` after each step.

Progress format:
- ‚úÖ Completed tasks
- üî≤ Pending tasks
- ‚ùå Failed tasks with error notes

Example:
```
## Deployment Progress

### 1. Containerization
- [x] Backend Dockerfile validated (backend/Dockerfile)
- [x] Frontend Dockerfile validated (frontend/Dockerfile)
- [x] Docker builds tested successfully

### 2. Infrastructure Files
- [x] Existing Bicep files reviewed
- [x] azure.yaml generated
- [x] Post-provision hooks configured
- [x] Files validated with no errors

### 3. Environment Setup
- [x] Azure CLI v2.54.0 installed
- [x] azd v1.5.0 installed
- [x] Environment 'techbookstore-prod' created
- [x] Environment variables set (6 variables)
- [x] Resource group created: rg-techbookstore-prod
- [x] Service Connector extension installed

### 4. Deployment
- [x] Preview completed successfully
- [ ] Deployment in progress
  - Attempt 1 failed: ACR authentication error
  - Fixed by verifying managed identity permissions
  - Retry in progress...

### 5. Summary
- [ ] Pending deployment completion
```

If a script fails, log the error, regenerate/fix the script, and retry until the step completes.

## **Tools Checklist**
Copilot MUST call the following tools as specified in the Execution Steps. Mark tools complete when called.

- [ ] appmod-get-available-region-sku (Step 2.2)
- [ ] appmod-get-iac-rules (Step 2.4)
- [ ] appmod-get-azd-app-logs (Step 4.3)
- [ ] appmod-summarize-result (Step 5.1)

Additional tools to be used:
- [ ] get_errors (Step 2.6)
- [ ] run_in_terminal (Multiple steps for az/azd commands)
- [ ] create_file (For azure.yaml and progress.copilotmd)
- [ ] read_file (For reviewing existing Bicep files)
