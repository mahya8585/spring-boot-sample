# Azure Deployment Plan for TechBookStore Project

## **Goal**
Provide a plan to provision Azure resources for the TechBookStore project using Azure CLI and Bicep. This plan focuses on infrastructure provisioning only and will create a production-ready environment for hosting two containerized services (backend Spring Boot and frontend React applications) with their required dependencies.

## **Azure Resources Architecture**
> **Install the mermaid extension in IDE to view the architecture.**

```mermaid
graph TD
%% Services
svcazurecontainerapps_backend["`Name: backend
Path: backend
Language: java`"]
svcazurecontainerapps_frontend["`Name: frontend
Path: frontend
Language: js`"]
subgraph "Compute Resources"
%% Resources
subgraph containerappenv["Azure Container Apps (ACA) Environment"]
azurecontainerapps_backend("`backend (Azure Container App)`")
azurecontainerapps_frontend("`frontend (Azure Container App)`")
end
containerappenv:::cluster
end
subgraph "Dependency Resources"
%% Dependency Resources
azuredatabaseforpostgresql_postgres["`postgres (Azure Database for PostgreSQL)`"]
azurecacheforredis_redis["`redis (Azure Cache for Redis)`"]
azurekeyvault_keyvault["`keyvault (Azure Key Vault)`"]
azureapplicationinsights_appinsights["`appinsights (Azure Application Insights)`"]
azurecontainerregistry_containerregistry["`containerregistry (azurecontainerregistry)`"]
end
%% Relationships
svcazurecontainerapps_backend --> |"hosted on"| azurecontainerapps_backend
azurecontainerapps_backend -.-> |"system-identity"| azuredatabaseforpostgresql_postgres
azurecontainerapps_backend -.-> |"system-identity"| azurecacheforredis_redis
azurecontainerapps_backend -.-> |"system-identity"| azurekeyvault_keyvault
azurecontainerapps_backend -.-> |"system-identity"| azureapplicationinsights_appinsights
azurecontainerapps_backend -.-> |"system-identity"| azurecontainerregistry_containerregistry
svcazurecontainerapps_frontend --> |"hosted on"| azurecontainerapps_frontend
azurecontainerapps_frontend -.-> |"http"| azurecontainerapps_backend
```

**Resource Relationships:**
- The backend Container App gets its container images from the Azure Container Registry
- The backend Container App connects to Azure Database for PostgreSQL using system-assigned managed identity for data persistence
- The backend Container App connects to Azure Cache for Redis using system-assigned managed identity for caching and session management
- The backend Container App retrieves secrets from Azure Key Vault using system-assigned managed identity for secure configuration management
- The backend Container App sends telemetry to Azure Application Insights for monitoring and diagnostics
- The frontend Container App serves the React application and makes HTTP requests to the backend Container App
- Both Container Apps run in the same Azure Container Apps Environment for optimal performance and networking

## **Azure Resource List**

| Resource Type | Resource Name | SKU / Configuration | Purpose |
|--------------|---------------|---------------------|---------|
| **Resource Group** | rg-techbookstore-prod | N/A | Contains all project resources |
| **Container Apps Environment** | cae-techbookstore | Consumption | Hosting environment for Container Apps |
| **Container App (Backend)** | ca-backend | Consumption | Hosts Spring Boot 3.5.0 Java 21 application |
| **Container App (Frontend)** | ca-frontend | Consumption | Hosts React 16 + Nginx application |
| **Container Registry** | crtechbookstore | Basic | Stores container images for backend and frontend |
| **PostgreSQL Flexible Server** | psql-techbookstore | Burstable B1ms (1 vCore, 2GB RAM) | Production database for application data |
| **Azure Cache for Redis** | redis-techbookstore | Basic C0 (250MB) | Caching and session storage |
| **Key Vault** | kv-techbookstore | Standard | Secure storage for secrets and connection strings |
| **Application Insights** | appi-techbookstore | N/A | Application monitoring and diagnostics |
| **Log Analytics Workspace** | log-techbookstore | Pay-as-you-go | Centralized logging for all resources |

## **Execution Steps**
> **Below are the steps for Copilot to follow; ask Copilot to update or execute this plan. Add check list for the steps.**

### 1. Environment Setup for Azure CLI
- [ ] Install Azure CLI if not already installed (https://aka.ms/installazurecliwindows)
- [ ] Login to Azure: `az login`
- [ ] Verify login: `az account show`
- [ ] Ensure there is a default subscription set. If provided, override the default subscription with the provided subscription ID
- [ ] Subscription ID: Use default subscription
- [ ] Install Service Connector Azure CLI extension: `az extension add --name serviceconnector-passwordless --upgrade`
- [ ] Verify extension installation: `az extension show --name serviceconnector-passwordless`

### 2. Provision Azure Infrastructure with Azure CLI
- [ ] **Provisioning tool:** Azure CLI with Bicep templates
- [ ] **Expected files:** Bicep templates in `infra/` directory
- [ ] Get current subscription ID: `az account show --query id -o tsv`
- [ ] Call tool `appmod-get-available-region-sku` to get available regions and SKUs for the following Azure resource types:
  - Microsoft.App/containerApps
  - Microsoft.App/managedEnvironments
  - Microsoft.ContainerRegistry/registries
  - Microsoft.DBforPostgreSQL/flexibleServers
  - Microsoft.Cache/redis
  - Microsoft.KeyVault/vaults
  - Microsoft.Insights/components
- [ ] Check if bicep files exist in `infra/` directory
- [ ] **If expected files exist:**
  - Review existing bicep templates
  - Verify resources match the requirements in this plan
  - Update existing files if any required resources are missing
- [ ] **If expected files do not exist:**
  - Create `infra/` directory
  - Call tool `appmod-get-iac-rules` with parameters:
    - deploymentTool: "azcli"
    - iacType: "bicep"
    - resourceTypes: ["containerapp", "azuredatabaseforpostgresql", "azurecacheforredis", "azurekeyvault", "azurecontainerregistry", "azureapplicationinsights"]
    - workspaceFolder: "c:/local-m/github/spring-boot-sample"
  - Generate the following Bicep files:
    - `infra/main.bicep` - Main deployment template
    - `infra/resources.bicep` - Resource definitions
    - `infra/main.parameters.json` - Parameter file for deployment
- [ ] Validate all generated Bicep files:
  - Call `get_errors` tool on all generated .bicep files
  - Fix any syntax errors or validation issues
  - Iterate until all files are error-free
  - Run `az bicep build --file infra/main.bicep` to verify compilation
- [ ] Create resource group (if not exists):
  ```bash
  az group create --name rg-techbookstore-prod --location <selected-region>
  ```
- [ ] Provision resources using Azure CLI deployment:
  - Determine targetScope from main.bicep file
  - **If targetScope = 'subscription':**
    ```bash
    az deployment sub create --name techbookstore-deployment --location <selected-region> --template-file infra/main.bicep --parameters infra/main.parameters.json
    ```
  - **If targetScope = 'resourceGroup':**
    ```bash
    az deployment group create --resource-group rg-techbookstore-prod --template-file infra/main.bicep --parameters infra/main.parameters.json
    ```
- [ ] Wait for deployment to complete and verify all resources are created successfully

### 3. Post-Provisioning Configuration
- [ ] **Configure Backend Container App connections:**
  - Create PostgreSQL connection with System-Assigned Managed Identity:
    ```bash
    az containerapp connection create postgres-flexible `
      --connection postgres-connection `
      --source-id /subscriptions/<sub-id>/resourceGroups/rg-techbookstore-prod/providers/Microsoft.App/containerApps/ca-backend `
      --target-id /subscriptions/<sub-id>/resourceGroups/rg-techbookstore-prod/providers/Microsoft.DBforPostgreSQL/flexibleServers/psql-techbookstore `
      --database techbookstore `
      --system-identity `
      --client-type springBoot `
      -y
    ```
  - Verify PostgreSQL connection:
    ```bash
    az containerapp connection show `
      --resource-group rg-techbookstore-prod `
      --name ca-backend `
      --connection postgres-connection `
      -o json
    ```
  - Create Redis connection with System-Assigned Managed Identity:
    ```bash
    az containerapp connection create redis `
      --connection redis-connection `
      --source-id /subscriptions/<sub-id>/resourceGroups/rg-techbookstore-prod/providers/Microsoft.App/containerApps/ca-backend `
      --target-id /subscriptions/<sub-id>/resourceGroups/rg-techbookstore-prod/providers/Microsoft.Cache/redis/redis-techbookstore `
      --system-identity `
      --client-type springBoot `
      -y
    ```
  - Verify Redis connection:
    ```bash
    az containerapp connection show `
      --resource-group rg-techbookstore-prod `
      --name ca-backend `
      --connection redis-connection `
      -o json
    ```
  - Grant Backend Container App access to Key Vault:
    ```bash
    # Get backend app's managed identity principal ID
    $backendIdentity = az containerapp show `
      --resource-group rg-techbookstore-prod `
      --name ca-backend `
      --query identity.principalId -o tsv
    
    # Assign Key Vault Secrets User role
    az role assignment create `
      --role "Key Vault Secrets User" `
      --assignee $backendIdentity `
      --scope /subscriptions/<sub-id>/resourceGroups/rg-techbookstore-prod/providers/Microsoft.KeyVault/vaults/kv-techbookstore
    ```
  - Configure Application Insights connection string in Container App environment variables:
    ```bash
    $instrumentationKey = az monitor app-insights component show `
      --resource-group rg-techbookstore-prod `
      --app appi-techbookstore `
      --query instrumentationKey -o tsv
    
    az containerapp update `
      --resource-group rg-techbookstore-prod `
      --name ca-backend `
      --set-env-vars APPLICATIONINSIGHTS_INSTRUMENTATION_KEY=$instrumentationKey
    ```
- [ ] **Verify all connections:**
  - List all connections for backend app:
    ```bash
    az containerapp connection list `
      --resource-group rg-techbookstore-prod `
      --name ca-backend `
      -o table
    ```
  - Review the `configurations` property in connection details to identify environment variable names
  - Document environment variables for application configuration

### 4. Summarize Result
- [ ] Use `appmod-summarize-result` tool to generate deployment summary
- [ ] Output file: `.azure/summary.copilotmd`
- [ ] Summary should include:
  - List of created resources with their resource IDs
  - Connection strings and environment variables configured
  - Managed identity principal IDs
  - Next steps for application deployment
  - Verification commands to test the infrastructure

## **Tools Checklist**
Copilot MUST call the following tools as specified in the Execution Steps. Mark tools complete when called. Do not make substitutions.
- [x] appmod-get-available-region-sku
- [x] appmod-get-iac-rules
- [x] appmod-summarize-result

## **Additional Notes**
- All resources will use system-assigned managed identities for passwordless authentication
- Container Apps will not have container images configured (provision-only mode)
- Backend application expects these environment variables to be set via Service Connector:
  - PostgreSQL: `AZURE_POSTGRESQL_HOST`, `AZURE_POSTGRESQL_DATABASE`, `AZURE_POSTGRESQL_USERNAME`, `AZURE_POSTGRESQL_PASSWORD` (or managed identity configurations)
  - Redis: `AZURE_REDIS_HOST`, `AZURE_REDIS_KEY`, `AZURE_REDIS_PORT`
  - Key Vault: `AZURE_KEYVAULT_ENDPOINT`
  - Application Insights: `APPLICATIONINSIGHTS_INSTRUMENTATION_KEY`
- Frontend will need backend URL configured as environment variable: `REACT_APP_API_URL`
- Estimated provisioning time: 15-20 minutes
