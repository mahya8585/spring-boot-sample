name: Build and Deploy Codelabs

on:
  push:
    branches: [ main ]
    paths: [ 'codelabs/**' ]
  pull_request:
    branches: [ main ]
    paths: [ 'codelabs/**' ]
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Setup Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.21'
          
      - name: Install claat
        run: go install github.com/googlecodelabs/tools/claat@latest
        
      - name: Verify claat installation
        run: claat version
        
      - name: Create docs directory
        run: mkdir -p docs/codelabs
        
      - name: Build codelabs
        run: |
          cd codelabs
          for file in *.md; do
            if [ -f "$file" ]; then
              echo "Building $file..."
              claat export -o ../docs/codelabs "$file"
            fi
          done
          
      - name: Generate codelabs index
        run: |
          cat > docs/index.html << 'EOF'
          <!DOCTYPE html>
          <html lang="ja">
          <head>
              <meta charset="UTF-8">
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
              <title>Legacy Spring Boot Modernization Workshop - Codelabs</title>
              <link rel="stylesheet" href="css/main.css">
          </head>
          <body>
              <header>
                  <h1>🚀 GitHub Copilot レガシーアプリケーション現代化ワークショップ</h1>
                  <p>Google Codelabs形式で学ぶ実践的モダナイゼーション手法</p>
              </header>
              
              <main>
                  <section class="codelabs-grid">
                      <div class="codelab-card">
                          <a href="codelabs/chapter1-current-state-analysis/">
                              <h2>第1章: 現状分析フェーズ</h2>
                              <p>GitHub Copilotを活用したレガシーアプリケーションの現状分析手法を習得する実践ワークショップ</p>
                              <div class="meta">
                                  <span class="duration">⏱️ 4-6時間</span>
                                  <span class="level">📊 中級</span>
                              </div>
                          </a>
                      </div>
                      
                      <div class="codelab-card coming-soon">
                          <h2>第2章: 課題抽出フェーズ</h2>
                          <p>詳細な課題分析とリスク評価手法</p>
                          <div class="meta">
                              <span class="status">🚧 準備中</span>
                          </div>
                      </div>
                      
                      <div class="codelab-card coming-soon">
                          <h2>第3章: 移行計画策定</h2>
                          <p>段階的モダナイゼーション戦略の策定</p>
                          <div class="meta">
                              <span class="status">🚧 準備中</span>
                          </div>
                      </div>
                  </section>
                  
                  <section class="info">
                      <h2>📚 ワークショップについて</h2>
                      <p>このワークショップシリーズでは、GitHub Copilotを活用してレガシーSpring Bootアプリケーションを効率的に現代化する手法を学びます。</p>
                      
                      <h3>🎯 対象者</h3>
                      <ul>
                          <li>中級以上のソフトウェアエンジニア</li>
                          <li>レガシーシステム現代化に取り組む開発者</li>
                          <li>GitHub Copilotを実務で活用したい方</li>
                      </ul>
                      
                      <h3>🛠️ 前提条件</h3>
                      <ul>
                          <li>Visual Studio Code + GitHub Copilot拡張機能</li>
                          <li>Java/Spring Boot の基礎知識</li>
                          <li>React/JavaScript の基礎知識</li>
                      </ul>
                  </section>
              </main>
              
              <footer>
                  <p>&copy; 2024 TechBookStore Workshop Series. 
                  <a href="https://github.com/shinyay/legacy-spring-boot-23-app-ws-2508">GitHub Repository</a></p>
              </footer>
          </body>
          </html>
          EOF
          
      - name: Generate CSS
        run: |
          mkdir -p docs/css
          cat > docs/css/main.css << 'EOF'
          :root {
              --primary-color: #1976d2;
              --secondary-color: #f5f5f5;
              --text-color: #333;
              --card-shadow: 0 2px 8px rgba(0,0,0,0.1);
              --border-radius: 8px;
          }
          
          * {
              margin: 0;
              padding: 0;
              box-sizing: border-box;
          }
          
          body {
              font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
              line-height: 1.6;
              color: var(--text-color);
              background-color: #fafafa;
          }
          
          header {
              background: linear-gradient(135deg, var(--primary-color), #1565c0);
              color: white;
              text-align: center;
              padding: 3rem 2rem;
          }
          
          header h1 {
              font-size: 2.5rem;
              margin-bottom: 0.5rem;
          }
          
          header p {
              font-size: 1.2rem;
              opacity: 0.9;
          }
          
          main {
              max-width: 1200px;
              margin: 0 auto;
              padding: 2rem;
          }
          
          .codelabs-grid {
              display: grid;
              grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
              gap: 2rem;
              margin-bottom: 3rem;
          }
          
          .codelab-card {
              background: white;
              border-radius: var(--border-radius);
              box-shadow: var(--card-shadow);
              transition: transform 0.2s ease, box-shadow 0.2s ease;
              overflow: hidden;
          }
          
          .codelab-card:hover {
              transform: translateY(-4px);
              box-shadow: 0 4px 16px rgba(0,0,0,0.15);
          }
          
          .codelab-card a {
              display: block;
              padding: 2rem;
              text-decoration: none;
              color: inherit;
          }
          
          .codelab-card h2 {
              color: var(--primary-color);
              margin-bottom: 1rem;
              font-size: 1.5rem;
          }
          
          .codelab-card p {
              color: #666;
              margin-bottom: 1rem;
          }
          
          .meta {
              display: flex;
              gap: 1rem;
              margin-top: 1rem;
          }
          
          .meta span {
              background: var(--secondary-color);
              padding: 0.3rem 0.8rem;
              border-radius: 16px;
              font-size: 0.9rem;
              color: #555;
          }
          
          .coming-soon {
              opacity: 0.7;
              pointer-events: none;
          }
          
          .coming-soon h2 {
              color: #999;
          }
          
          .info {
              background: white;
              padding: 2rem;
              border-radius: var(--border-radius);
              box-shadow: var(--card-shadow);
          }
          
          .info h2 {
              color: var(--primary-color);
              margin-bottom: 1rem;
          }
          
          .info h3 {
              color: #555;
              margin: 1.5rem 0 0.5rem;
          }
          
          .info ul {
              margin-left: 1.5rem;
              margin-bottom: 1rem;
          }
          
          .info li {
              margin-bottom: 0.3rem;
          }
          
          footer {
              text-align: center;
              padding: 2rem;
              color: #666;
              border-top: 1px solid #eee;
              margin-top: 3rem;
          }
          
          footer a {
              color: var(--primary-color);
              text-decoration: none;
          }
          
          footer a:hover {
              text-decoration: underline;
          }
          
          @media (max-width: 768px) {
              header h1 {
                  font-size: 2rem;
              }
              
              .codelabs-grid {
                  grid-template-columns: 1fr;
              }
              
              main {
                  padding: 1rem;
              }
          }
          EOF
          
      - name: Generate PWA manifest
        run: |
          cat > docs/manifest.json << 'EOF'
          {
            "name": "Legacy Spring Boot Modernization Workshop",
            "short_name": "SB Workshop",
            "description": "GitHub Copilotを活用したレガシーアプリケーション現代化ワークショップ",
            "start_url": "/",
            "display": "standalone",
            "background_color": "#ffffff",
            "theme_color": "#1976d2",
            "icons": [
              {
                "src": "icon-192.png",
                "sizes": "192x192",
                "type": "image/png"
              },
              {
                "src": "icon-512.png", 
                "sizes": "512x512",
                "type": "image/png"
              }
            ]
          }
          EOF
          
      - name: List generated files
        run: |
          echo "Generated files:"
          find docs -type f -name "*.html" -o -name "*.css" -o -name "*.json" | sort
          
      - name: Deploy to GitHub Pages
        if: github.ref == 'refs/heads/main' && github.event_name == 'push'
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./docs
          force_orphan: true
          
      - name: Comment on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v6
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '🚀 Codelabs built successfully! The content will be deployed to GitHub Pages when this PR is merged to main.'
            });