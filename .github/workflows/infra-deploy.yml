name: Infrastructure Deployment

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment'
        required: true
        type: choice
        options:
          - dev
          - staging
          - production

permissions:
  id-token: write
  contents: read

jobs:
  deploy-infrastructure:
    name: Deploy Infrastructure to ${{ inputs.environment }}
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Azure Login with OIDC
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Set environment-specific variables
        id: env-vars
        run: |
          echo "RESOURCE_GROUP=${{ vars.AZURE_RESOURCE_GROUP }}" >> $GITHUB_OUTPUT
          echo "LOCATION=${{ vars.AZURE_LOCATION }}" >> $GITHUB_OUTPUT
          echo "ENVIRONMENT_NAME=${{ inputs.environment }}-${{ github.run_number }}" >> $GITHUB_OUTPUT

      - name: Create Resource Group
        run: |
          az group create \
            --name ${{ steps.env-vars.outputs.RESOURCE_GROUP }} \
            --location ${{ steps.env-vars.outputs.LOCATION }} \
            --tags environment=${{ inputs.environment }} project=TechBookStore

      - name: Deploy Bicep template
        id: bicep-deploy
        run: |
          az deployment group create \
            --resource-group ${{ steps.env-vars.outputs.RESOURCE_GROUP }} \
            --template-file ./infra/main.bicep \
            --parameters environmentName=${{ steps.env-vars.outputs.ENVIRONMENT_NAME }} \
            --parameters location=${{ steps.env-vars.outputs.LOCATION }} \
            --parameters postgresqlAdminUsername=${{ secrets.POSTGRESQL_ADMIN_USERNAME }} \
            --parameters postgresqlAdminPassword=${{ secrets.POSTGRESQL_ADMIN_PASSWORD }} \
            --parameters postgresqlDatabaseName=techbookstore

      - name: Get deployment outputs
        id: outputs
        run: |
          OUTPUTS=$(az deployment group show \
            --resource-group ${{ steps.env-vars.outputs.RESOURCE_GROUP }} \
            --name main \
            --query properties.outputs)
          
          echo "ACR_NAME=$(echo $OUTPUTS | jq -r '.AZURE_CONTAINER_REGISTRY_NAME.value')" >> $GITHUB_OUTPUT
          echo "BACKEND_APP_NAME=$(echo $OUTPUTS | jq -r '.BACKEND_APP_NAME.value')" >> $GITHUB_OUTPUT
          echo "FRONTEND_APP_NAME=$(echo $OUTPUTS | jq -r '.FRONTEND_APP_NAME.value')" >> $GITHUB_OUTPUT
          echo "BACKEND_APP_URL=$(echo $OUTPUTS | jq -r '.BACKEND_APP_URL.value')" >> $GITHUB_OUTPUT
          echo "FRONTEND_APP_URL=$(echo $OUTPUTS | jq -r '.FRONTEND_APP_URL.value')" >> $GITHUB_OUTPUT

      - name: Display deployment information
        run: |
          echo "### ðŸš€ Infrastructure Deployment Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** ${{ inputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "**Resource Group:** ${{ steps.env-vars.outputs.RESOURCE_GROUP }}" >> $GITHUB_STEP_SUMMARY
          echo "**Container Registry:** ${{ steps.outputs.outputs.ACR_NAME }}" >> $GITHUB_STEP_SUMMARY
          echo "**Backend App:** ${{ steps.outputs.outputs.BACKEND_APP_NAME }}" >> $GITHUB_STEP_SUMMARY
          echo "**Frontend App:** ${{ steps.outputs.outputs.FRONTEND_APP_NAME }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Backend URL:** ${{ steps.outputs.outputs.BACKEND_APP_URL }}" >> $GITHUB_STEP_SUMMARY
          echo "**Frontend URL:** ${{ steps.outputs.outputs.FRONTEND_APP_URL }}" >> $GITHUB_STEP_SUMMARY
